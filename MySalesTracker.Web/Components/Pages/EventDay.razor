@page "/day/{id:int}"
@attribute [Authorize]
@inject EventService EventSvc
@inject ProductService ProductSvc
@inject PriceRuleService PriceRuleSvc
@inject SaleService SaleSvc
@inject NavigationManager Nav
@inject IConfiguration Config
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

@if (day is null)
{
    <p>Loading‚Ä¶</p>
}
else
{
    <div class="mb-3 d-flex justify-content-start align-items-center gap-3">
        <h2 class="mb-0">@day.Date.ToDateTime(TimeOnly.MinValue).ToString("dd.MM dddd", Bg)</h2>
        <a href="/day/@id/report" class="btn btn-outline-primary">–î–Ω–µ–≤–µ–Ω –û—Ç—á–µ—Ç</a>
    </div>

    <p><a href="/events">‚¨ÖÔ∏è –°—ä–±–∏—Ç–∏—è</a> | @day.Event.Name</p>    

    <div class="mb-2 d-flex gap-3 flex-wrap align-items-center">
        <select @bind="productId" @bind:after="OnProductChanged" class="form-select" style="width: 16.5rem">
            <option value="">–ü—Ä–æ–¥—É–∫—Ç‚Ä¶</option>
            @foreach (var p in products)
            {
                <option value="@p.ProductId">@p.Name</option>
            }
        </select>

        @if (selectedProduct?.Brand == Brand.Ceramics)
        {
            <!-- Use text + inputmode = decimal to reliably show decimal keypad on mobile (iOS/Android) -->
            <input type="text" inputmode="decimal" enterkeyhint="done" autocomplete="off"
                   placeholder="–¶–µ–Ω–∞‚Ä¶" class="form-control" style="width: 10rem"
                   @bind="priceText" @bind:event="oninput" @bind:after="ClearValidationMessage" />
        }
        else
        {
            <select @bind="price" @bind:after="OnPriceChanged" class="form-select" style="width: 8rem">
                <option value="">–¶–µ–Ω–∞‚Ä¶</option>
                @foreach (var r in priceOptions)
                {
                    <option value="@r.Price">@r.Price</option>
                }
            </select>
        }

        <!-- Discount input -->
        <input type="text" inputmode="decimal" enterkeyhint="done" autocomplete="off"
               placeholder="–û—Ç—Å—Ç—ä–ø–∫–∞‚Ä¶" class="form-control" style="width: 8rem"
               @bind="discountText" @bind:event="oninput" @bind:after="ClearValidationMessage" />

        <!-- Note input -->
        @* <input type="text" inputmode="text" enterkeyhint="done" autocomplete="off"
               placeholder="–ë–µ–ª–µ–∂–∫–∞‚Ä¶" class="form-control" style="width: 8rem"
               @bind="note" @bind:event="oninput" /> *@

        <button class="btn btn-primary" style="width: 8rem; height: 2.75rem" @onclick="Add" disabled="@DisableAddButton">
            @(editingSaleId.HasValue ? "–ó–∞–ø–∞–∑–∏" : "–î–æ–±–∞–≤–∏")
        </button>
        @if (editingSaleId.HasValue)
        {
            <button class="btn btn-secondary" style="width: 8rem; height: 2.75rem" @onclick="CancelEdit">–û—Ç–∫–∞–∂–∏</button>
        }
    </div>

    @if (!string.IsNullOrEmpty(validationMessage))
    {
        <div class="alert alert-warning py-2 px-3 mb-3">
            @validationMessage
        </div>
    }

    @foreach (var summary in brandSummaries)
    {
      <h4 class="mt-4">@summary.Brand.GetDisplayName()</h4>
      <table class="table table-striped align-middle compact-table" style="margin-left: -1.5rem; margin-right: -1.5rem;">
          <thead class="table-warning">
              <tr>
                  <th class="px-3">–ß–∞—Å</th>
                  <th class="px-3">–ü—Ä–æ–¥—É–∫—Ç</th>
                  <th class="px-3">–±—Ä.</th>
                  <th class="px-3">–¶–µ–Ω–∞</th>
                  <th class="px-3">–û—Ç—Å—Ç.</th>
                  @* <th class="px-3">–ë–µ–ª–µ–∂–∫–∞</th> *@
                  <th class="px-3">–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
          </thead>
          <tbody>
              @foreach (var s in summary.Sales)
              {
                  <tr>
                      <td class="px-3">@TimeZoneInfo.ConvertTimeFromUtc(s.CreatedUtc, SofiaTimeZone).ToString("HH:mm", Bg)</td>
                      <td class="px-3">@s.Product.Name</td>
                      <td class="px-3">@s.QuantityUnits</td>
                      <td class="px-3">@s.Price.ToString("0.00")</td>
                      <td class="px-3" style="color: @(s.DiscountValue > 0 ? "inherit" : "lightgray")">@s.DiscountValue.ToString("0.00")</td>
                      @* <td class="px-3">@s.Notes</td> *@
                      <td class="px-3 text-end">
                          <div class="btn-group" role="group">
                              <button class="btn btn-outline-primary btn-sm" @onclick="() => EditSale(s.SaleId)">Edit</button>
                              <button class="btn btn-outline-danger btn-sm" @onclick="() => DeleteSale(s.SaleId)">Delete</button>
                          </div>
                      </td>
                  </tr>
              }
          </tbody>
          <tfoot>
              <tr>
                  <td class="px-3 fw-bold" colspan="2">–û–±—â–æ @summary.Brand.GetDisplayName():</td>
                  <td class="px-3 fw-bold">@summary.TotalQuantityUnits.ToString("0")</td>
                  <td class="px-3 fw-bold">@summary.NetTotal.ToString("0.00")</td>
                  <td class="px-3 fw-bold">@summary.TotalDiscount.ToString("0.00")</td>
              </tr>
          </tfoot>
      </table>
    }
}

@code {
    [Parameter] public int id { get; set; }
    Domain.Entities.EventDay? day;
    List<Product> products = new();
    List<PriceRule> priceOptions = new();
    List<PriceRule> allPriceRules = new();
    List<BrandSalesSummary> brandSummaries = new();
    HubConnection? hubConnection;

    // Order of brand tables
    Brand[] brandOrder = new[] { Brand.Totem, Brand.Ceramics, Brand.Candles };

    int? productId;
    decimal? price;
    string? priceText;    // manual price input (ceramics)
    string? discountText; // manual discount input (all brands)
    string? note;
    int qty = 1;
    string? validationMessage;
    int? editingSaleId;   // Track if editing a sale
    double scrollPositionBeforeEdit = 0;

    static readonly CultureInfo Bg = CultureInfo.GetCultureInfo("bg-BG");

    bool DisableAddButton => !string.IsNullOrEmpty(validationMessage);

    
    // "FLE Standard Time" is the Windows time zone ID for Sofia, Bulgaria (UTC+2/UTC+3)
    static readonly TimeZoneInfo SofiaTimeZone = TimeZoneInfo.FindSystemTimeZoneById("FLE Standard Time");

    Product? selectedProduct => products.FirstOrDefault(p => p.ProductId == productId);

    protected override async Task OnInitializedAsync()
    {
        day = await EventSvc.GetEventDayByIdAsync(id);
        if (day == null) return;

        products = await ProductSvc.GetActiveProductsAsync();

        allPriceRules = await PriceRuleSvc.GetAllPriceRulesAsync(day.Date);

        await ReloadSalesAsync();
        await EnsureHubConnectionAsync();
    }

    async Task OnProductChanged()
    {
        if (selectedProduct?.Brand == Brand.Ceramics)
        {
            priceOptions.Clear();
            price = null;
            priceText = null;
            qty = 1; // no rules => default 1
        }
        else
        {
            priceOptions = productId is null
                ? new()
                : await ProductSvc.GetPriceRulesForProductAsync(productId.Value);


            // TODO: Hard-coded product names and prices are used for setting default values. This creates a tight coupling 
            // between the UI and business logic, making the code fragile to product name changes in the database.
            var defaultPrice = (selectedProduct?.Brand, selectedProduct?.Name) switch
            {
                (Brand.Totem, "–ë–∞–Ω–¥–∞–Ω–∏") => 40.00m,
                (Brand.Totem, "–†—ä–∫–∞–≤–∏—Ü–∏") => 35.00m,
                (Brand.Candles, _) => 19.00m,
                _ => 0m
            };

            price = priceOptions.FirstOrDefault(r => r.Price == defaultPrice)?.Price 
                    ?? priceOptions.FirstOrDefault()?.Price;
            priceText = null; 
            qty = 1;
        }

        ClearValidationMessage();
        StateHasChanged();
    }

    async Task Add()
    {
        if (day is null) return;

        if (productId is null)
        {
            validationMessage = "–ü–æ—Å–æ—á–∏ –∫–∞–∫–≤–æ –ø—Ä–æ–¥–∞–≤–∞—à, –Ω–∞ –≤—Ä–∞—á–∫–∞ –ª–∏ —â–µ —Ö–æ–¥–∏—à –ø–æ—Å–ª–µ?";
            return;
        }

        ClearValidationMessage();

        // Ensure price is set (parse string for ceramics)
        if (selectedProduct?.Brand == Brand.Ceramics)
        {
            if (!DecimalParsingHelper.TryParseDecimal(priceText, out var parsedPrice))
            {
                validationMessage = $"–ù–µ–≤–∞–ª–∏–¥–µ–Ω —Ñ–æ—Ä–º–∞—Ç –Ω–∞ —Ü–µ–Ω–∞—Ç–∞ {priceText}. –í—ä–≤–µ–¥–∏ –Ω–∞–ø—Ä–∏–º–µ—Ä: 12.50";
                return;
            }

            price = parsedPrice;
        }

        if (price is null)
        {
            validationMessage = "–í—ä–≤–µ–¥–∏ —Ü–µ–Ω–∞ –∑–∞ –ø—Ä–æ–¥—É–∫—Ç–∞, –±–µ–∑ –ø–∞—Ä–∏ –ª–∏ –≥–æ –¥–∞–≤–∞—à üëÄ?";
            return;
        }

        //TODO: is this the right place for the discount variable? Or should it be at the beginning of the code section with the other variables?
        var discount = 0m;
        if (!string.IsNullOrWhiteSpace(discountText))
        {
            if (!DecimalParsingHelper.TryParseDecimal(discountText, out var parsedDiscount))
            {
                validationMessage = "–¢–∞—è –æ—Ç—Å—Ç—ä–ø–∫–∞ –Ω–µ —Ç—Ä—è–±–≤–∞ –ª–∏ –¥–∞ –µ –ø–∞—Ä–∏—á–Ω–∞ –µ–¥–∏–Ω–∏—Ü–∞? –ò–ª–∏ —â–µ –º—É –¥–∞–≤–∞—à –Ω–µ—â–æ –¥—Ä—É–≥–æ?";
                return;
            }

            discount = parsedDiscount;
        }

        if(discount > price)
        {
            validationMessage = "–ö–æ –Ω–∞–ø—Ä–∞–π –≤–ï –º–∞–Ω–Ø–∫? –û—Ç—Å—Ç—ä–ø–∫–∞—Ç–∞ —Ç–∏ –µ –ø–æ-–≥–æ–ª—è–º–∞ –æ—Ç —Ü–µ–Ω–∞—Ç–∞! –î–∞ –Ω–µ –∏–º –¥–∞–≤–∞—à —Ç–∏ –ø–∞—Ä–∏ —Å–∞–º–æ –∏ —Å–∞–º–æ –¥–∞ –≥–æ –≤–∑–µ–º–∞—Ç?";
            return;
        }

        var unitsPerSale = await PriceRuleSvc.GetUnitsForProductAsync(productId.Value, price.Value, day.Date);

        var savedScrollPosition = 0.0;
        if (editingSaleId.HasValue)
        {
            // Update existing sale
            await SaleSvc.UpdateSaleAsync(
                editingSaleId.Value,
                day.EventDayId,
                price.Value,
                unitsPerSale.Units,
                discount,
                note,
                unitsPerSale.PriceRuleId);

            savedScrollPosition = scrollPositionBeforeEdit;
            scrollPositionBeforeEdit = 0;
            editingSaleId = null;
        }
        else
        {
            await SaleSvc.CreateSaleAsync(
                day.EventDayId,
                productId.Value,
                unitsPerSale.PriceRuleId,
                price.Value,
                unitsPerSale.Units,
                discount,
                note);
        }

        await ReloadSalesAsync();

        if (savedScrollPosition > 0)
        {
            await Task.Delay(100); // Small delay to let UI update
            await JSRuntime.InvokeVoidAsync("window.scrollTo", new { top = savedScrollPosition, behavior = "smooth" });
        }

        // Reset quick inputs but keep current product selection
        price = null; priceText = null; discountText = null; note = null; qty = 1;
        await OnProductChanged(); // repopulate priceOptions for the currently selected product
    }

    private async Task OnPriceChanged()
    {
        if (productId is null || day is null) return;

        if (selectedProduct?.Brand == Brand.Ceramics)
        {
            // Parse typed price using current culture
            price = DecimalParsingHelper.TryParseDecimal(priceText, out var parsed)
                ? parsed
                : null;
            qty = 1;
        }
        else if (price is not null)
        {
            var unitsPerSale = await PriceRuleSvc.GetUnitsForProductAsync(productId.Value, price.Value, day.Date);
            qty = unitsPerSale.Units;
        }

        ClearValidationMessage();

        StateHasChanged();
    }

    void ClearValidationMessage()
    {
        validationMessage = null;
    }


    // TODO: check the usage of this one - too many calls can cause the pool full issue with the database.
    async Task ReloadSalesAsync()
    {
        var summaries = await SaleSvc.GetBrandSalesSummariesAsync(id);

        brandSummaries = summaries
            .OrderBy(s => Array.IndexOf(brandOrder, s.Brand))
            .ToList();
    }

    async Task EnsureHubConnectionAsync()
    {
        if (hubConnection is not null) return;

        var hubPath = Config["SignalR:SalesHubPath"];
        if (string.IsNullOrWhiteSpace(hubPath))
        {
            throw new InvalidOperationException("SignalR:SalesHubPath is not configured.");
        }

        hubConnection = new HubConnectionBuilder()
            .WithUrl(Nav.ToAbsoluteUri(hubPath))
            .WithAutomaticReconnect()
            .Build();

        hubConnection.On<int, int>("SaleCreated", async (eventDayId, saleId) =>
        {
            if (day is null || eventDayId != day.EventDayId) return;
            await InvokeAsync(async () =>
            {
                await ReloadSalesAsync();
                StateHasChanged();
            });
        });

        await hubConnection.StartAsync();
        await hubConnection.InvokeAsync("JoinDayGroup", id);
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is null) return;
        try
        {
            if (hubConnection.State == HubConnectionState.Connected)
            {
                await hubConnection.InvokeAsync("LeaveDayGroup", id);
            }
            await hubConnection.DisposeAsync();
        }
        catch
        {
            // Swallow to avoid throwing during circuit disposal.
        }
    }

    private async Task EditSale(int saleId)
    {
        var sale = await SaleSvc.GetSaleByIdAsync(saleId);
        if (sale is null) return;

        scrollPositionBeforeEdit = await JSRuntime.InvokeAsync<double>("eval", "window.scrollY");

        editingSaleId = saleId;
        productId = sale.ProductId;
        
        await OnProductChanged();

        price = sale.Price;
        priceText = sale.Price.ToString("0.00", Bg);
        discountText = sale.DiscountValue > 0 ? sale.DiscountValue.ToString("0.00", Bg) : null;
        note = sale.Notes;

        StateHasChanged();

        // Scroll to top smoothly
        await JSRuntime.InvokeVoidAsync("window.scrollTo", new { top = 0, behavior = "smooth" });
    }

    private async Task DeleteSale(int saleId)
    {
        if (day is null) return;

        // Using JavaScript confirm dialog for simplicity
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "–°–∏–≥—É—Ä–µ–Ω –ª–∏ —Å–∏, —á–µ –∏—Å–∫–∞—à –¥–∞ –∏–∑—Ç—Ä–∏–µ—à —Ç–∞–∑–∏ –ø—Ä–æ–¥–∞–∂–±–∞?");
        if (!confirmed) return;

        await SaleSvc.DeleteSaleAsync(saleId, day.EventDayId);
        await ReloadSalesAsync();
    }

    private void CancelEdit()
    {
        editingSaleId = null;
        productId = null;
        price = null;
        priceText = null;
        discountText = null;
        note = null;
        qty = 1;

        ClearValidationMessage();
        StateHasChanged();
    }
}
